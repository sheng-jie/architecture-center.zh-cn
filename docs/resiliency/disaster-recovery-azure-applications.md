---
title: "Azure 应用程序灾难恢复"
description: "有关在Microsoft Azure 上设计应用程序以实现灾难恢复的技术概述和深入信息。"
author: adamglick
ms.date: 05/26/2017
ms.openlocfilehash: 7235e752cf1b96e392a700b223d63b07c0f85b66
ms.sourcegitcommit: 3d9ee03e2dda23753661a80c7106d1789f5223bb
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/23/2018
---
# <a name="disaster-recovery-for-azure-applications"></a>Azure 应用程序灾难恢复

灾难恢复 (DR) 侧重于从应用程序功能的灾难性损失中恢复。 例如，如果托管应用程序的 Azure 区域变得不可用，则需制定一个计划，以便在另一个区域运行应用程序或访问数据。 

业务和技术所有者必须在灾难期间确定需要多少功能。 此功能级别表现为几种形式：完全不可用、部分可用（功能减弱或延迟处理）或完全可用。

复原和高可用性策略旨在处理临时故障情况。  此计划的执行涉及人员、流程以及允许系统继续正常运转的支持性应用程序。 你的计划应包括排练故障和测试数据库恢复，以确保该计划的可靠性。 

## <a name="azure-disaster-recovery-features"></a>Azure 灾难恢复功能

与可用性注意事项一样，Azure 提供了旨在支持灾难恢复的[复原技术指南](./index.md)。 Azure 的可用性功能与灾难恢复之间还存在某种关系。 例如，跨容错域管理角色可提高应用程序的可用性。 如果没有此项管理，则未经处理的硬件故障会演变为“灾难”情形。 利用这些可用性功能和策略是应用程序防灾的重要部分。 但是，本文不仅介绍一般的可用性问题，还涉及到严重（且罕见）的灾难事件。

## <a name="multiple-datacenter-regions"></a>多个数据中心区域
Azure 在世界各地许多不同的区域保留了数据中心。 此基础结构支持多种灾难恢复方案，如系统提供的将 Azure 存储异地复制到次要区域。 你还可以轻松而经济地将云服务部署到全球多个位置。 将此与在多个区域生成和维护自己的数据中心的成本和困难程度相比，高下立见。 将数据和服务部署到多个数据中心可保护应用程序不会在单个区域中发生重大中断。 设计灾难恢复计划时，务必了解配对区域这一概念。 有关详细信息，请参阅[业务连续性和灾难恢复 (BCDR)：Azure 配对区域](/azure/best-practices-availability-paired-regions)。

## <a name="azure-site-recovery"></a>Azure Site Recovery

[Azure Site Recovery](/azure/site-recovery/) 提供了一种简单方法，用于在区域之间复制 Azure VM。 它的管理开销极低，因为无需在次要区域中预配任何附加资源。 启用复制时，Site Recovery 会根据源 VM 设置自动在目标区域中创建所需的资源。 它提供自动连续复制，只需单击一下鼠标就能执行应用程序故障转移。 此外，可以通过测试故障转移运行灾难恢复演练，而不影响生产工作负荷或正在进行的复制。 

## <a name="azure-traffic-manager"></a>Azure 流量管理器
发生数据中心特有的故障后，必须将流量重定向到另一区域中的服务或部署。 通过诸如 Azure 流量管理器之类的服务处理此操作是最有效的方法，主要区域发生故障时，此服务会将用户流量自动故障转移到另一个区域。 设计有效的 DR 策略时，了解流量管理器基础知识很重要。

流量管理器根据流量路由方法和终结点的运行状况，使用域名系统 (DNS) 将客户端请求定向到最合适的终结点。 在下图中，用户连接到流量管理器 URL (`http://myATMURL.trafficmanager.net`)，这是实际站点 URL（`http://app1URL.cloudapp.net` 和 `http://app2URL.cloudapp.net`）的抽象形式。 用户请求根据你配置的[流量管理器路由方法](/azure/traffic-manager/traffic-manager-routing-methods)路由到正确的基础 URL。 在本文中，我们只讨论故障转移选项。

![通过 Azure 流量管理器路由](./images/disaster-recovery-azure-applications/routing-using-azure-traffic-manager.png)

配置流量管理器时，需提供一个新的流量管理器 DNS 前缀，用户将用它来访问你的服务。 流量管理器当前将负载均衡从区域级别向上提升了一个级别。 对于流量管理器管理的所有部署，其 DNS 均映射到某个 CNAME。

在流量管理器内，指定在发生故障时将用户路由到的部署的优先级列表。 流量管理器监视部署终结点。 如果主部署变得不可用，流量管理器会将用户路由到优先级列表中的下一个部署。

虽然流量管理器决定了在故障转移时前往何方，但在非故障转移模式下，你可以决定故障转移域是处于休眠还是活动状态（这与流量管理器无关）。 流量管理器在主站点中检测到故障后，无论该站点当前是否为用户提供服务，都会转移到故障转移站点。

有关 Azure 流量管理器工作原理的详细信息，请参阅：

* [流量管理器概述](/azure/traffic-manager/traffic-manager-overview/)
* [流量管理器路由方法](/azure/traffic-manager/traffic-manager-routing-methods)
* [配置故障转移路由方法](/azure/traffic-manager/traffic-manager-configure-failover-routing-method/)

## <a name="azure-disaster-scenarios"></a>Azure 灾难情况
以下部分涵盖多种不同类型的灾难情况。 区域范围的服务中断不是应用程序范围内发生故障的唯一原因。 设计不良和管理错误也会导致中断。 请在恢复计划的设计和测试阶段设想可能导致故障的原因，这样做很重要。 一个好的计划可充分利用 Azure 功能，并通过应用程序特有的策略强化这些功能。 由应用程序的重要性、恢复点目标 (RPO) 和恢复时间目标 (RTO) 确定所选的响应。

### <a name="application-failure"></a>应用程序故障
如前所述，Azure 流量管理器会自动处理因主机虚拟机中的底层硬件或操作系统软件引起的故障。 Azure 会创建新的角色实例，并将它添加到可用池中。 如果有多个角色实例正在运行，Azure 会将处理任务转移到其他正在运行的角色实例，同时替换发生故障的节点。

即使没有任何硬件或操作系统底层故障，也可能出现严重的应用程序错误。 应用程序可能因逻辑错误或数据完整性问题导致的灾难性异常而发生故障。 必须在应用程序代码中加入足够的遥测数据，使监视系统可检测到故障情况并通知应用程序管理员。 充分了解灾难恢复过程的管理员在解决关键错误时，可以决定是触发故障转移过程还是接受可用性中断。

### <a name="data-corruption"></a>数据损坏
Azure 自动将 Azure SQL 数据库和 Azure 存储数据在同一区域的不同容错域内冗余地存储三次。 如果使用异地复制，则再将这些数据在另一个区域内存储三次。 但是，如果用户或应用程序损坏了主副本中的数据，则会将损坏情况迅速复制到其他副本。 不幸的是，这会产生多份损坏的数据。

要应对可能的数据损坏，可以采用两种做法。 首先，可以管理自定义备份策略。 可以将备份存储在 Azure 中或存储在本地，具体取决于业务需求或治理监管。 另一种做法是使用时间点还原选项来恢复 SQL 数据库。 有关详细信息，请参阅下面的[灾难恢复的数据策略](#data-strategies-for-disaster-recovery)部分。

### <a name="network-outage"></a>网络中断
当 Azure 网络的某些部分中断时，可能无法访问应用程序或数据。 如果一个或多个角色实例因网络问题而不可用，则 Azure 将利用应用程序剩余的可用实例。 如果应用程序因 Azure 网络中断而无法访问其数据，你可以使用缓存数据在本地以应用程序功能减弱的方式运行。 你需要将灾难恢复策略设计为在应用程序中以功能减弱的方式运行。 某些应用程序可能做不到这一点。

另一个选项是将数据存储在备用位置，直到连接恢复。 如果减弱功能不是好办法，则剩余的选项为应用程序停机或故障转移到备用区域。 设计运行功能减弱的应用程序多出于业务决策而非技术决策。 [应用程序功能减弱](#reduced-application-functionality)部分深入讨论了这一问题。

### <a name="failure-of-a-dependent-service"></a>从属服务故障
Azure 提供的许多服务可能会定期停机。 例如，[Azure Redis 缓存](https://azure.microsoft.com/services/cache/)是一种多租户服务，用于向应用程序提供缓存功能。 设想如果从属服务不可用，应用程序中将发生什么，这样做很重要。 此方案在许多方面与网络中断方案类似。 但是，单独考量每一项服务有望改进整个计划。

例如，Azure Redis 缓存从云服务部署内部为应用程序提供缓存，从而提供灾难恢复的优势。 首先，服务现在运行在部署本地的角色上。 因此，在云服务的总体管理过程中，可更好地监视和管理缓存的状态。 此类缓存还为缓存数据提供一些新功能，比如高可用性，用于在单个节点发生故障时，通过在其他节点上维护重复的副本来保留缓存数据。

请注意，高可用性会降低吞吐量并增大延迟，因为写入操作还必须更新所有辅助副本。 存储缓存数据所需的内存量实际会增加一倍，进行容量规划时必须考虑到这一点。  此示例表明，每项从属服务都可能具有提高总体可用性和帮助抵御灾难性故障的能力。

通过每个从属服务，应够可以了解服务中断造成的影响。 在缓存示例中，或许可以直接从数据库访问数据，直到还原缓存为止。 这在提供对应用程序数据的完全访问权限的同时，会导致性能降低。

### <a name="region-wide-service-disruption"></a>区域范围的服务中断
以前的故障主要还是可在同一 Azure 区域内应对的故障。 但是，还必须为整个区域发生服务中断的可能性做好准备。 发生区域范围的服务中断时，数据的本地冗余副本不可用。 如果启用了异地复制，则在异地区域内另有 Blob 和表的三个副本。 如果 Microsoft 声明区域发生故障，Azure 会将所有 DNS 条目将重新映射到异地复制的区域。

> [!NOTE]
> 注意，对此过程无任何控制权，并且仅对区域范围的服务中断进行此过程。 考虑使用 [Azure Site Recovery](/azure/site-recovery/) 获取更有利的 RPO 和 RTO。 Site Recovery 可让应用程序确定什么是可以接受的服务中断，以及何时故障转移到已复制的 VM。

### <a name="azure-wide-service-disruption"></a>Azure 范围的服务中断
在灾难规划中，必须考虑到所有可能发生的灾难情况。 最严重的一个故障将同时涉及所有 Azure 区域。 与其他服务中断一样，在这种情况下，你可能决定接受临时停机的风险。 跨越多个区域的广泛服务中断比涉及从属服务或单个区域的孤立服务中断少见得多。

但是，你可能认为某些任务关键型应用程序需要一个针对多区域服务中断的备份计划。 此计划可能包括故障转移到[备用云](#alternative-cloud)或[混合本地和云解决方案](#hybrid-on-premises-and-cloud-solution)中的服务。

### <a name="reduced-application-functionality"></a>应用程序功能减弱
设计良好的应用程序通常使用一些服务，这些服务通过实现松散耦合的信息互换模式相互通信。 适合 DR 的应用程序需要在服务级别分离职责。 这可以防止从属服务中断导致整个应用程序停止运行。 例如，以 Y 公司的电子商务应用程序为例，该应用程序可能由以下模块构成：

* **产品目录**：便于用户浏览产品。
* **购物车**：便于用户在其购物车中添加/删除产品。
* **订单状态**：显示用户订单的发货状态。
* **订单提交**：通过提交订单并付款，完成购物过程。
* **订单处理**：验证订单的数据完整性并执行数量可用性检查。

当此应用程序中的某个服务依赖项变得不可用时，在依赖项恢复之前，该服务如何工作？ 设计良好的系统会通过在设计时和运行时分离职责来实施隔离边界。 可以将每个故障分类为可恢复和不可恢复。 不可恢复的错误会使服务停止运行，但可以通过备选项来规避可恢复的错误。 可通过自动处理故障和采取备用措施解决的特定问题对用户是透明的。 在更严重的服务中断期间，应用程序可能完全不可用。 第三种做法是继续使用减弱的功能处理用户请求。

例如，如果托管订单的数据库停运，则“订单处理”服务无法处理销售事务。 根据体系结构的不同，该应用程序的“订单提交”和“订单处理”服务可能难以或无法继续。 如果该应用程序未设计成处理这种情况，则整个应用程序可能脱机。 但是，如果产品数据存储在其他位置，则仍可使用“产品目录”模块来查看产品。 不过，该应用程序的其他部分不可用，如下订单或库存查询。

决定哪项减弱的应用程序功能可用既是一项业务决策，也是一项技术决策。 你必须决定该应用程序如何向用户通知所有临时问题。 在上例中，该应用程序可能允许查看产品以及将这些产品添加到购物车。 但是，当用户尝试进行购买时，该应用程序向用户通知订购功能暂时不可用。 对于客户来说，这不是理想状态，但这样确实可防止应用程序范围的服务中断。

## <a name="data-strategies-for-disaster-recovery"></a>灾难恢复的数据策略
恰当的数据处理是灾难恢复计划中颇具难度的一方面。 在恢复过程中，数据还原通常最耗时间。 在发生故障之后，为减弱功能做出的不同选择使数据的故障恢复和一致性面临严峻挑战。

其中一个考虑因素是需要还原或维护应用程序数据的副本。 此数据会在辅助站点用于参考和事务目的。 本地部署需要一个成本高昂且耗时漫长的规划过程才能实施多区域灾难恢复策略。 方便的是，包括 Azure 在内的大多数云提供商均已允许将应用程序部署到多个区域。 这些区域分散在各地，因此应该极少发生多个区域同时服务中断的情况。 能够跨区域处理数据的策略是任何灾难恢复计划成功的决定性因素之一。

以下部分讨论与数据备份、引用数据和事务数据相关的灾难恢复方法。

### <a name="backup-and-restore"></a>备份和还原
定期备份应用程序数据可为某些灾难恢复方案提供支持。 不同的存储资源需要使用不同的方法。

#### <a name="sql-database"></a>SQL 数据库
对于基本、标准和高级 SQL 数据库层，可以利用时间点还原来恢复数据库。 有关详细信息，请参阅[概述：云业务连续性与使用 SQL 数据库进行数据库灾难恢复](/azure/sql-database/sql-database-business-continuity/)。 另一种做法是对 SQL 数据库使用活动异地复制。 这会自动将数据库更改复制到相同甚至不同 Azure 区域中的辅助数据库。 这提供了一些本文介绍的手动程度更高的数据同步技术的潜在替代方法。 有关详细信息，请参阅[概述：SQL 数据库活动异地复制](/azure/sql-database/sql-database-geo-replication-overview/)。

还可以使用手动程度更高的方法进行备份和还原。 使用 DATABASE COPY 命令可创建具有事务一致性的数据库备份副本。 也可以使用 Azure SQL 数据库的导入/导出服务，该服务支持将数据库导出到存储在 Azure Blob 存储中的 BACPAC 文件（包含数据库架构和关联数据的压缩文件）。

Azure 存储内置的冗余性在同一区域中创建备份文件的两个副本。 但是，由运行备份过程的频率决定 RPO，即可能在灾难情况下丢失的数据量。 例如，假设每个整点执行一次备份，而灾难发生在整点前的两分钟。 那么，会丢失在执行上次备份之后记录的 58 分钟的数据。 此外，为了应对区域范围的服务中断，应将 BACPAC 文件复制到备用区域。 之后可以在备用区域还原这些备份。 有关更多详细信息，请参阅[概述：云业务连续性与使用 SQL 数据库进行数据库灾难恢复](/azure/sql-database/sql-database-business-continuity/)。

#### <a name="azure-storage"></a>Azure 存储
对于 Azure 存储，可制定一个自定义备份过程，也可使用许多第三方备份工具中的某一个。 请注意，在大多数应用程序设计中，还有许多其他的复杂情况，其中存储资源互相引用对方。 例如，设想一个 SQL 数据库，其中一列链接到 Azure 存储中的 Blob。 如果未能同时进行备份，则数据库可能会提供一个指针，指向在发生故障之前未备份的 Blob。 应用程序或灾难恢复计划必须实现在恢复后处理这种不一致性的过程。

#### <a name="other-data-platforms"></a>其他数据平台
服务架构 (IaaS) 托管的其他数据平台（如 Elasticsearch 或 MongoDB）在创建集成的备份和还原过程时具有自己的功能和注意事项。 对于这些数据平台，一般建议使用任何基于集成的本机或可用复制或快照功能。 如果这些功能不存在或不适用，则考虑使用 Azure 备份服务或托管/非托管磁盘快照来创建应用程序数据的时间点副本。 无论哪种情况，都务必确定如何实现一致的备份，尤其是当应用程序数据分布在多个文件系统，或者使用卷管理器或基于软件的 RAID 将多个驱动器合并到单个文件系统时。

### <a name="reference-data-pattern-for-disaster-recovery"></a>灾难恢复的引用数据模式
引用数据是支持应用程序功能的只读数据。 这些数据通常不经常更改。 尽管备份和还原是处理区域范围的服务中断的一种方法，但 RTO 耗时相对较长。 将应用程序部署到次要区域后，有一些策略可改进引用数据的 RTO。

由于引用数据不经常更改，因此可通过在次要区域内保留引用数据的永久副本，缩短 RTO。 这样可消除发生灾难时还原备份所需的时间。 要满足多区域灾难恢复要求，必须将应用程序和引用数据一起部署到多个区域。 如[高可用性的引用数据模式](high-availability-azure-applications.md#reference-data-pattern-for-high-availability)中所述，可以将引用数据部署到角色本身、外部存储或这两者的组合。

计算节点内引用数据部署模型还隐式满足了灾难恢复要求。 将引用数据部署到 SQL 数据库需要将引用数据的副本部署到每个区域。 同样的策略也适用于 Azure 存储。 必须将存储在 Azure 存储中的任何引用数据副本部署到主要区域和次要区域。

![引用数据发布到主要区域和次要区域](./images/disaster-recovery-azure-applications/reference-data-publication-to-both-primary-and-secondary-regions.png)

必须对所有数据（包括引用数据）实现自己的应用程序特有的备份例程。 仅在整个区域范围的服务中断时，使用跨区域的异地复制副本。 为了防止出现长时间的停机，应将应用程序的任务关键部分的数据部署到次要区域。 有关此拓扑的示例，请参阅[主动-被动模型](#active-passive)。

### <a name="transactional-data-pattern-for-disaster-recovery"></a>灾难恢复的事务数据模式
实施功能完备的灾难模式策略需要将事务数据异步复制到次要区域。 可进行复制的实际时间范围将决定应用程序的 RPO 特征。 仍然可以从主要区域恢复在复制期间丢失的数据。 以后还可以与次要区域合并。

以下体系结构示例介绍在故障转移情况下处理事务数据的几种不同方式。 这些示例并未尽列，注意到这一点很重要。 例如，可将中间存储位置（如队列）替换为 Azure SQL 数据库。 队列自身可以是 Azure 存储或 Azure 服务总线队列（请参阅 [Azure 队列和服务总线队列 - 比较与对照](/azure/service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted/)）。 服务器存储目标也可能有所不同，如使用 Azure 表而不是 SQL 数据库。 此外，在不同步骤中，还可插入辅助角色作为中介。 其目的不在于精确地模仿这些体系结构，而是在恢复事务数据和相关模块时考虑各种备选方法。

#### <a name="replication-of-transactional-data-in-preparation-for-disaster-recovery"></a>复制事务数据以准备灾难恢复
设想一个应用程序，其中使用 Azure 存储队列保存事务数据。 这允许辅助角色在去耦体系结构中处理事务数据并将其放入服务器数据库。 如果前端角色要求立即查询这些数据，则这要求事务使用某种形式的临时缓存。 根据数据丢失承受程度的不同，可以选择复制队列、数据库或所有存储资源。 如果只是复制数据库，则当主要区域停机后，仍然可以在主要区域恢复时恢复队列中的数据。

下图显示一种体系结构，其中跨区域同步了服务器数据库。

![复制事务数据以准备灾难恢复](./images/disaster-recovery-azure-applications/replicate-transactional-data-in-preparation-for-disaster-recovery.png)

实现这种体系结构的最大难题是区域之间的复制策略。 [Azure SQL 数据同步](/azure/sql-database/sql-database-get-started-sql-data-sync/)服务可以实现这种类型的复制。 撰写本文时，该服务处于预览阶段，尚不建议用于生产环境。 有关详细信息，请参阅[概述：云业务连续性与使用 SQL 数据库进行数据库灾难恢复](/azure/sql-database/sql-database-business-continuity/)。 对于生产应用程序，必须投资购入第三方解决方案或在代码中创建自己的复制逻辑。 根据体系结构的不同，可能会进行双向复制，这种复制更为复杂。

一种可能的实现方法是在上述示例中使用中间队列。 处理数据并将其放入最终存储目标的辅助角色可以同时在主要区域和次要区域内做出更改。 这些任务并非不重要，而有关复制代码的完整指导超出本文的范畴。 应投入大量时间来开发和测试将数据复制到次要区域的方法。 应进行其他处理和测试，以确保故障转移和恢复过程正确处理任何可能发生的数据不一致情况或复制事务。

> [!NOTE]
> 本文侧重于平台即服务 (PaaS)。 但是，使用 Azure 虚拟机的混合应用程序仍具有其他复制和可用性选项。 这些混合应用程序使用基础结构即服务 (IaaS) 在 Azure 中的虚拟机上托管 SQL Server。 因此，可在 SQL Server 中使用传统的可用性方法，如 AlwaysOn 可用性组或日志传送。 某些方法（如 AlwaysOn）只能在本地 SQL Server 与 Azure 虚拟机之间发挥作用。 有关详细信息，请参阅 [Azure 虚拟机中 SQL Server 的高可用性和灾难恢复](/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr/)。
> 
> 

#### <a name="reduced-application-functionality-for-transaction-capture"></a>使用减弱的应用程序功能捕获事务
另外设想一个以功能减弱的方式运行的体系结构。 次要区域中的应用程序会停用所有功能，如报告、商业智能 (BI) 或清空队列。 它仅接受业务要求定义的事务工作流的最重要类型。 系统将捕获事务并将其写入队列。 在服务中断的初始阶段，系统可以推迟数据处理。 如果主要区域内的系统在预期的时间范围内重新激活，则主要区域内的辅助角色可能会清空队列。 此过程不需要合并数据库。 如果主要区域的服务中断超出可承受的范围，则应用程序可开始处理队列。

在此方案中，次要区域内的数据库包含增量事务数据，一旦主要区域重新激活，就必须合并此类数据。 下图展示了此策略，用于临时存储事务数据，直到还原主要区域。

![使用减弱的应用程序功能捕获事务](./images/disaster-recovery-azure-applications/reduced-application-functionality-for-transaction-capture.png)

有关具有复原功能的 Azure 应用程序的数据管理方法的更多讨论，请参阅[防故障：弹性云体系结构指南](https://channel9.msdn.com/Series/FailSafe)。

## <a name="deployment-topologies-for-disaster-recovery"></a>灾难恢复的部署拓扑
必须对任务关键型应用程序做好准备，以处理区域范围的服务中断。 可以将多区域部署策略合并到运营规划中。

多区域部署可能需要使用 IT 流程在经历灾难后将应用程序数据和引用数据发布到次要区域。 如果应用程序要求立即进行故障转移，则部署过程可能涉及主动/被动或主动/主动设置。 这种类型的部署具有在备用区域内运行应用程序的现有实例。 Azure 流量管理器等路由服务可在 DNS 级别提供负载均衡服务。 此类工具可检测到服务中断，并在需要时会用户路由到其他区域。

若要实现成功的 Azure 灾难恢复，应从一开始就将它内置到解决方案中。 云提供了其他可用于在灾难期间从故障中恢复的选项，而传统的托管提供商无法提供此类选项。 具体是指，你可以在其他区域快速、动态地分配资源，避免在发生故障前因资源闲置而产生成本。

以下部分涵盖灾难恢复的不同部署拓扑。 通常，在提高可用性时，需要在增加成本或复杂性之间取得平衡。

### <a name="single-region-deployment"></a>单区域部署
单区域部署实际上不是一种灾难恢复拓扑，而是旨在与其他体系结构进行对比。 Azure 中的应用程序经常采用单区域部署，不过，这种部署并不符合灾难恢复拓扑的要求。

下图演示了在单个 Azure 区域内运行的应用程序。 Azure 流量管理器以及使用容错域和升级域可提高区域内应用程序的可用性。

![单区域部署](./images/disaster-recovery-azure-applications/single-region-deployment.png)

在此方案中，数据库是单一故障点。 虽然 Azure 会将不同容错域中的数据复制到内部副本，但这种复制仅在同一区域内进行。 应用程序无法承受灾难性故障。 如果区域变得不可用，则容错域也不可用，其中包括所有服务实例和存储资源。

对于所有应用程序（最不重要的除外），必须制定计划以将应用程序部署到不同区域中的多个区域内。 在考虑要使用哪种部署拓扑时，还应考虑 RTO 和成本的限制。

现在来看支持在不同区域内进行故障转移的特定方法。 以下示例都使用两个区域说明该过程。

### <a name="failover-using-azure-site-recovery"></a>使用 Azure Site Recovery 进行故障转移

使用 Azure Site Recovery 启用 Azure VM 复制时，它会在次要区域中创建多个资源：

- 资源组。
- 虚拟网络 (VNet)。
- 存储帐户。 
- 在故障转移后用于保留 VM 的可用性集。

主要区域中 VM 磁盘上写入的数据会持续传输到次要区域中的存储帐户。 目标存储帐户中每隔几分钟就会生成恢复点。 启动故障转移时，将在目标资源组、VNet 和可用性集中创建已恢复的 VM。 在故障转移期间，可以选择任何可用的恢复点。


### <a name="redeployment-to-a-secondary-azure-region"></a>重新部署到次要 Azure 区域
在重新部署到次要区域的方法中，只有主要区域有应用程序和数据库在运行。 次要区域未设置为自动故障转移。 因此，在发生灾难时，必须启动新区域内服务的所有部分。 其中包括将云服务上传到 Azure、部署云服务、还原数据和更改 DNS 以重新路由流量。

虽然这是最实惠的多区域选项，但其 RTO 特征最差。 在此模型中，服务包和数据库备份存储在本地或次要区域的 Azure Blob 存储中。 但必须先部署新服务并还原数据，才能继续操作。 即使完全自动从备份存储中传输数据，预配新数据库环境仍然会花费大量时间。 将数据从备份磁盘存储移至次要区域内的空数据库是还原过程中成本最高的部分， 但必须这样做才能使新数据库进入正常运行状态，因为并未复制该数据库。

最佳方法是将服务包存储在次要区域内的 Blob 存储中。 这样不必将包上传到 Azure，而从本地的开发计算机进行部署时就要这样做。 可以使用 PowerShell 脚本，迅速将服务包从 Blob 存储部署到新云服务中。

此选项仅适用于可承受高 RTO 的非关键应用程序。 例如，此选项可能适用于可关闭数小时，但需在 24 小时内可用的应用程序。

![重新部署到次要 Azure 区域](./images/disaster-recovery-azure-applications/redeploy-to-a-secondary-azure-region.png)

### <a name="active-passive"></a>主动-被动
许多公司倾向于选择主动-被动拓扑。 与重新部署方法相比，这种拓扑增加相对较少的成本即可提高 RTO。 在此方案中，同样存在主辅 Azure 区域。 所有流量均流向主要区域内的主动部署。 次要区域为灾难恢复所做的准备更充分，因为两个区域内均运行有数据库。 而且，它们之间还建立了同步机制。 这种备用方法可能涉及两种变化形式：仅数据库方法或在次要区域内进行完全部署的方法。

#### <a name="database-only"></a>仅数据库
在主动-被动拓扑的第一种变化形式中，只有主要区域部署了云服务应用程序。 但是，与重新部署方法不同，这两个区域与数据库内容进行同步。 （有关详细信息，请参阅[灾难恢复的事务数据模式](#transactional-data-pattern-for-disaster-recovery)部分。）发生灾难时，激活要求会更低。 启动次要区域内的应用程序，将连接字符串更改为新数据库，并更改 DNS 条目以重新路由流量。

与重新部署方法一样，服务包应已存储在次要区域内的 Azure Blob 存储中，以便更快进行部署。 但是，这不会产生数据库还原操作所需的大部分开销，因为数据库已就绪并且正在运行。 这样可节省大量时间，因此是一种经济型 DR 模式（也是最常用的模式）。

![主动-被动（仅数据库）](./images/disaster-recovery-azure-applications/active-passive-database-only.png)

#### <a name="full-replica"></a>完整副本
在主动-被动拓扑的第二种变化形式中，主要区域和次要区域均为完全部署。 这种部署包括云服务和同步数据库。 但是，只有主要区域在主动处理来自用户的网络请求。 只有当主要区域出现服务中断时，次要区域才会激活。 在这种情况下，会将所有新网络请求路由到次要区域。 Azure 流量管理器可自动管理此故障转移。

由于已部署相关服务，因此故障转移的速度比仅数据库变化形式更快。 此拓扑的 RTO 非常短。 在主要区域发生故障时，次要故障转移区域必须能够立即投入使用。

除了更快的响应时间，此拓扑还预分配和部署备份服务，避免在发生灾难期间因空间不足而无法分配新实例。 如果辅助 Azure 区域接近最大容量，则这一点很重要。 任何服务级别协议 (SLA) 都无法保证你可以立即在任何区域部署一个或多个新的云服务。

为了尽量缩短此模型的响应时间，主要区域和次要区域的规模（角色实例数）必须相近。 尽管存在一些优点，但由于为未使用的计算实例付费的成本高昂，通常这不是最明智的财务选择。 因此，更常见的做法是在次要区域内使用规模略有缩减的云服务版本。 这样就能在必要时快速故障转移和横向扩展辅助部署。 应当自动完成故障转移过程，以便一旦主要区域发生故障，即根据负载激活其他实例。 这可能涉及某种类型的自动缩放机制，如[虚拟机规模集](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview/)。

下图展示了主动-被动拓扑中的一种模型，其中主要区域和次要区域均包含完全部署的云服务。

![主动-被动（完整副本）](./images/disaster-recovery-azure-applications/active-passive-full-replica.png)

### <a name="active-active"></a>主动-主动
在主动-主动拓扑中，云服务和数据库在这两个区域内均部署齐全。 与主动-被动模型不同的是，两个区域都会接收用户流量。 此选项产生的恢复时间最快。 相关服务已经过扩展，以在每个区域处理一部分负载。 已启用 DNS，便于使用次要区域。 在确定如何将用户路由到相应的区域的过程中，还有其他复杂因素。 可以采用轮循机制计划。 很可能某些用户会使用其数据的主副本所在的特定区域。

在故障转移时，只需禁止 DNS 访问主要区域。 这可以将所有流量路由到次要区域。

即使在此模型中，也有一些变化形式。 例如，下图展示了一个拥有数据库主控副本的主要区域。 两个区域内的云服务均写入该主数据库。 辅助部署可从主数据库或复制的数据库进行读取。 本例中的复制为单向。

![主动-主动](./images/disaster-recovery-azure-applications/active-active.png)

上图中的主动-主动体系结构有一个缺点。 第二个区域必须访问第一个区域内的数据库，因为主控副本存放在那里。 从区域外部访问数据时，性能大幅下降。 在跨区域调用数据库时，应考虑使用某种类型的批处理方法以提高这些调用的性能。 有关详细信息，请参阅[如何使用批处理来改善 SQL 数据库应用程序的性能](/azure/sql-database/sql-database-use-batching-to-improve-performance/)。

另一种备选体系结构可能要求每个区域直接访问其数据库。 在该模型中，将需要进行某种类型的双向复制以同步每个区域内的数据库。

在以前的拓扑中，缩短 RTO 通常会增加成本和复杂程度。 主动-主动拓扑弃用了这种成本模式。 在主动-主动拓扑中，主要区域内需要的实例数量可能不像主动-被动拓扑那么多。 如果主动-被动体系结构的主要区域内有 10 个实例，则在每个主动-主动体系结构的区域内可能只需要 5 个实例。 现在两个区域分担负载。 如果在被动区域内将 10 个实例保持在热备用状态以等待故障转移，则这样做可能比主动-被动拓扑更为节省成本。

如果直到主要区域还原后才意识到这一点，则次要区域的新用户可能会突然间猛增。 如果在主要区域发生服务中断时每个服务器上有 10,000 个用户，则次要区域现在突然间必须处理 20,000 个用户。 针对次要区域的监视规则必须检测到这种增长情况，并将次要区域内的实例增加一倍。 有关详细信息，请参阅[故障检测](#failure-detection)部分。

## <a name="hybrid-on-premises-and-cloud-solution"></a>混合本地和云解决方案
另一个灾难恢复策略是设计一个同时在本地和云中运行的混合应用程序。 根据应用程序的不同，主要区域可能在任一位置。 以前面的体系结构为例，并假设主要区域和次要区域均位于本地。

这些混合体系结构中有一些难题。 首先，本文大部分内容处理的是 PaaS 体系结构模式。 Azure 中的典型 PaaS 应用程序依赖 Azure 特有的构件，如角色、云服务和流量管理器。 为此类型的 PaaS 应用程序创建本地解决方案所需的体系结构显著不同。 就管理或成本角度而言，这一点可能不可行。

但是，对已迁移到云中的传统体系结构（比如基于 IaaS 的体系结构）来说，混合灾难恢复解决方案面临的挑战更少。 IaaS 应用程序使用云中的虚拟机，这些虚拟机在本地具有直接等效项。 使用虚拟网络还可将云中的虚拟机与本地网络资源相连。 这样就产生了多种仅 PaaS 应用程序所不具备的可能性。 例如，SQL Server 可利用灾难恢复解决方案，如 AlwaysOn 可用性组和数据库镜像。 有关详细信息，请参阅 [Azure 虚拟机中 SQL Server 的高可用性和灾难恢复](/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr/)。

IaaS 解决方案还为本地应用程序使用 Azure 作为故障转移选项提供一个更方便的途径。 可能在现有的本地区域内具有完全正常运行的应用程序。 但如果缺少资源，无法维护分散在各地的区域以进行故障转移，该怎么办呢？ 可能决定使用虚拟机和虚拟网络在 Azure 中运行应用程序。 在这种情况下，可以定义将数据同步到云的过程。 然后，Azure 部署变成用于故障转移的次要区域。 主要区域仍为本地应用程序。 有关 IaaS 体系结构和功能的详细信息，请参阅[虚拟机文档](https://azure.microsoft.com/documentation/services/virtual-machines/)。

## <a name="alternative-cloud"></a>备用云
在某些情况下，Microsoft Azure 虽然拥有众多功能，但可能仍不符合内部的符合性规则或组织所需的策略。 如果云服务提供商发生全球性的服务中断，即使是最完善的准备和设计也无法在发生灾难时实施备份系统。

应将可用性要求与提高可用性所需的成本和复杂程度进行比较。 执行风险分析，并为解决方案定义 RTO 和 RPO。 如果应用程序无法承受任何停机，则可能需要考虑使用其他云解决方案。 除非整个 Internet 同时瘫痪，否则在 Azure 发生全球性的访问故障时，其他云解决方案仍将正常运转。

和混合方案一样，其他云解决方案中也可存在以前灾难恢复体系结构中的故障转移部署。 备用云 DR 站点应仅用于那些 RTO 只允许极短停机时间（如有）的解决方案。 请注意，使用 Azure 以外 DR 站点的解决方案将需要在配置、开发、部署和维护方面做更多工作。 此外，在跨云的体系结构中实施经认证的做法也更加困难。 尽管云平台的高级概念相似，但 API 和体系结构各有不同。

如果 DR 策略依赖于多个云平台，那么，在解决方案设计中加入抽象层就很有用。 这样就不必为各种云平台开发和维护同一应用程序的两个不同版本来应对灾难。 和混合方案一样，在这些情况下使用 Azure 虚拟机或 Azure 容器服务可能比云特定的 PaaS 设计更加方便。

## <a name="automation"></a>自动化
我们刚刚讨论的某些模式需要迅速激活脱机部署以及还原系统的特定部分。 自动化脚本可按需激活资源以及迅速部署解决方案。 下面的 DR 相关自动化示例使用 [Azure PowerShell](https://msdn.microsoft.com/library/azure/jj156055.aspx)，不过，使用 [Azure CLI](https://docs.microsoft.com/cli/azure/get-started-with-azure-cli) 或[服务管理 REST API](https://msdn.microsoft.com/library/azure/ee460799.aspx) 也是不错的选择。

自动化脚本可管理 Azure 以非透明方式处理的各个 DR 环节。 这会生成一致且可重复的结果，最大程度减少人为错误。 预先定义的 DR 脚本还可缩短在发生灾难期间重新生成系统及其组成部分的时间。 不想尝试自己解决如何在停机时还原站点，因为分分秒秒都在损失金钱。

请从头到尾反复测试脚本。 验证这些脚本的基本功能后，请确保在[灾难模拟](#disaster-simulation)中测试它们。 这样有助于揭示脚本或过程中的缺陷。

自动化的最佳实践是为 Azure 灾难恢复创建 PowerShell 脚本或命令行接口 (CLI) 的存储库。 请明确标注这些脚本并对它们分类，以便快速访问。 指派专人来管理脚本的存储库和版本控制。 请通过参数解释和脚本使用示例，妥善记录这些脚本。 另外请确保将此文档与 Azure 部署保持同步。 这就是让专人全权管理整个存储库的意图所在。

## <a name="failure-detection"></a>故障检测
若要正确地处理可用性和灾难恢复的问题，必须可检测和诊断故障。 请执行高级服务器和部署监视，以便在系统或其组件突然变得不可用时快速发现该问题。 评估云服务及其依赖项的总体运行状况的监视工具可完成这其中的一部分工作。 [System Center 2016](https://www.microsoft.com/server-cloud/products/system-center-2016/) 就是一款合适的 Microsoft 工具。 第三方工具也可提供监视功能。 大多数监视解决方案跟踪关键的性能计数器和服务可用性。

尽管这些工具很重要，但必须规划云服务中的故障检测和报告。 此外还必须规划正确使用 Azure 诊断。 自定义性能计数器或事件日志条目也可成为总体策略的一部分。 这样可在故障期间提供更多数据以迅速诊断问题并恢复所有功能。 它还为监视工具提供其他指标，用于确定应用程序的运行状况。 有关详细信息，请参阅[在 Azure 云服务中启用 Azure 诊断](/azure/cloud-services/cloud-services-dotnet-diagnostics/)。 有关如何规划总体“运行状况模型”的讨论，请参阅[防故障：弹性云体系结构指南](https://channel9.msdn.com/Series/FailSafe)。

## <a name="disaster-simulation"></a>灾难模拟
模拟测试涉及在真实工作环境下营造小规模的真实情形，以观察团队成员的反应。 模拟还会展示在恢复计划中概述的解决方案的效果。 执行模拟的方式应以所营造的情景不会中断实际业务，但仍感觉像真实情况为准。

设想在应用程序中设计某种类型的“开关面板”以手动模拟可用性问题。 例如，通过软开关，使订购模块发生故障，从而触发该模块的数据库访问异常。 可将类似的轻型方法用于网络接口级别的其他模块。

将在模拟期间重点关注任何未充分解决的问题。 模拟的方案必须完全可控。 也就是说，即便恢复计划似乎会失败，也可以使情况恢复正常，而不会导致任何重大损害。 还应向高级管理人员通知将执行模拟练习的时间和方式，这一点也很重要。 此计划应详细说明时间或在模拟期间受影响的资源。 还应定义测试灾难恢复计划时成功的衡量标准。

如果使用 Azure Site Recovery，则可以执行到 Azure 的测试故障转移，以便在不丢失任何数据或造成停机的情况下验证复制策略或执行灾难恢复演练。 测试故障转移不会对正在进行的 VM 复制或生产环境造成任何影响。

其他几种方法也可以测试灾难恢复计划。 但是，其中大多数只是这些基本方法的变化形式。 此测试的目的是评估恢复计划的可行性。 灾难恢复测试专注于细节，以发现基本恢复计划中的漏洞。

## <a name="service-specific-guidance"></a>服务特定指南

以下主题介绍特定于灾难恢复的 Azure 服务：

| 服务 | 主题 |
|---------|-------|
| 云服务 | [发生影响 Azure 云服务的 Azure 服务中断时该怎么办](/azure/cloud-services/cloud-services-disaster-recovery-guidance) |
| Key Vault | [Azure Key Vault 可用性和冗余](/azure/key-vault/key-vault-disaster-recovery-guidance) |
|存储 | [在 Azure 存储中断时该怎么办](/azure/storage/storage-disaster-recovery-guidance) |
| SQL 数据库 | [还原 Azure SQL 数据库或故障转移到辅助数据库](/azure/sql-database/sql-database-disaster-recovery) |
| 虚拟机 | [发生影响 Azure 虚拟机的 Azure 服务中断事件时该怎么办](/azure/virtual-machines/virtual-machines-disaster-recovery-guidance) |
| 虚拟网络 | [虚拟网络 - 业务连续性](/azure/virtual-network/virtual-network-disaster-recovery-guidance) |


