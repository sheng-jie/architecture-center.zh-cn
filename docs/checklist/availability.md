---
title: "可用性核对清单"
description: "为设计过程中的可用性考虑因素提供指导的核对清单。"
author: dragon119
ms.date: 01/10/2018
ms.custom: checklist
ms.openlocfilehash: 324d8200d822eb1a7dce95ba4b2a7f29b00fb291
ms.sourcegitcommit: 441185360db49cfb3cf39527b68f318d17d4cb3d
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/19/2018
---
# <a name="availability-checklist"></a>可用性核对清单

可用性指系统正常工作时间所占的比例，是[软件质量的构成要素](../guide/pillars.md)之一。 使用此核对清单可以从可用性的角度审查应用程序的体系结构。 

## <a name="application-design"></a>应用程序设计

**避免任何单点故障。** 为避免单点故障影响可用性，应该将所有组件、服务、资源和计算实例部署为多个实例。 这包括身份验证机制。 将应用程序设计为可配置为使用多个实例，自动检测失败，并将请求重定向到未失败的实例（平台并不在其中自动执行此操作）。

**根据服务级别目标解构工作负荷。** 如果服务由重要和比较不重要的工作负荷组成，请以不同的方式进行管理，并指定服务功能和实例数，以符合其可用性要求。

**最小化和了解服务依赖项。** 尽可能将使用过的不同服务数降到最低，并确保了解所有存在于系统中的功能和服务依赖项， 包括这些依赖项的性质、失败造成的影响，或整个应用程序上每个服务降低的性能。 请参阅[定义复原要求](../resiliency/index.md#defining-your-resiliency-requirements)。

**尽量设计幂等的任务和消息**。 如果某个操作可以重复多次且生成相同的结果，则该操作是幂等的。 幂等性可以确保重复的请求不会导致问题。 消息使用者与它们执行的操作应该具有幂等性，以便重复以前执行的操作不会使结果无效。 这可能意味着要检测重复消息或使用乐观方法来处理冲突以确保一致性。

**使用消息代理来为重要事务实现高可用性。** 许多云应用程序使用消息传递来启动以异步方式执行的任务。 若要保证传送消息，消息传送系统应提供高可用性。 [Azure 服务总线消息传递](/azure/service-bus-messaging)实施“至少一次”的语义。 这意味着，发布到队列的消息不会丢失，不过在某些情况下可能会发送重复的副本。 如果消息处理是幂等的（请参阅前一项），则重复传送应该不是问题。

**将应用程序设计为可正常降级。** 应用程序上的负载可能超出一个或多个部件的容量，导致降低可用性和连接失败。 缩放有助于缓解此问题，但可能会达到资源可用性或成本等其他因素施加的限制。 当应用程序达到资源限制时，应采取适当的措施来尽量减小对用户的影响。 例如，在电子商务系统中，如果订单处理子系统处于高压状态或发生故障，可以暂时禁用该子系统，同时允许其他功能（例如浏览产品目录）继续工作。 适当的做法是延后对故障子系统发出的请求，例如，仍然允许客户提交订单，但同时要保存订单，以便在订单子系统稍后再次可用时进行处理。

**适当处理急剧突发事件。** 大多数应用程序需要在不同的时间处理不同的工作负荷。 自动缩放有助于处理负载，但可能需要一些时间使其他实例联机并处理请求。 通过将应用程序设计为将请求加入其使用的服务队列，并在队列接近完全容量时适当降级，以防止突发和意外的活动高峰导致超出应用程序的处理能力。 确保有足够的性能和容量可供非高峰条件清空队列和处理未完成的请求。 有关详细信息，请参阅 [Queue-Based Load Leveling Pattern](https://msdn.microsoft.com/library/dn589783.aspx)（基于队列的负载调节模式）。

## <a name="deployment-and-maintenance"></a>部署和维护

**部署服务的多个实例。** 如果应用程序依赖于服务的单个实例，则会造成单一故障点。 预配多个实例能够提高复原能力和可伸缩性。 对于 [Azure 应用服务](/azure/app-service/app-service-value-prop-what-is/)，请选择提供多个实例的[应用服务计划](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/)。 对于 Azure 云服务，请将每个角色配置为使用[多个实例](/azure/cloud-services/cloud-services-choose-me/#scaling-and-management)。 对于 [Azure 虚拟机 (VM)](/azure/virtual-machines/virtual-machines-windows-about/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)，请确保 VM 体系结构包含多个 VM，并且每个 VM 包含在[可用性集][availability-sets]中。

**考虑跨多个区域部署应用程序。** 如果将应用程序部署到单个区域，在发生整个区域不可用的情况时（这种情况很罕见），应用程序也不可用。 根据应用程序的 SLA 条款，这种情况可能不可接受。 为此，请考虑跨多个区域部署应用程序及其服务。

**自动化和测试部署与维护任务。** 分布式应用程序由多个必须共同工作的部件组成。 应该使用经过测试和证实的机制（例如脚本）来自动化部署。 这些脚本和应用程序可更新并验证配置，以及自动化部署过程。 使用 [Azure 资源管理器模板](/azure/azure-resource-manager/resource-group-authoring-templates)预配 Azure 资源。 此外，应使用自动化方法来执行应用程序更新。 务必全面测试所有过程，以确保错误不会导致其他停机情况。 所有的部署工具必须有适当的安全限制，以保护部署的应用程序；慎重定义和强制实施部署策略，并将人为介入的需要降到最低。

**使用平台的过渡和生产功能。** 例如，Azure 应用服务支持[部署槽位](/azure/app-service/web-sites-staged-publishing)。在将某个部署切换到生产环境之前，可以使用这些槽位来过渡该部署。 Azure Service Fabric 支持对应用程序服务执行[滚动升级](/azure/service-fabric/service-fabric-application-upgrade)。

**将虚拟机 (VM) 放在可用性集中。** 要最大程度地提高可用性，请为每个 VM 角色创建多个实例，并将这些实例放在同一个可用性集中。 如果有多个 VM 充当不同的角色（例如不同的应用程序层），请为每个 VM 角色创建一个可用性集。 例如，为 Web 层创建一个可用性集，并为数据层创建另一个可用性集。

## <a name="data-management"></a>数据管理

**Azure 存储中的异地复制数据**。 Azure 存储中的数据在数据中心自动复制。 为了获得更高可用性，请使用读取访问异地冗余存储 (-RAGRS)，它将数据复制到次要区域，并提供次要位置数据的只读访问权限。 即使出现完全的区域性中断或灾难，数据也会得到持久保护。 有关详细信息，请参阅 [Azure 存储复制](/azure/storage/storage-redundancy)。

**异地复制数据库**。 Azure SQL 数据库和 Cosmos DB 都支持异地复制，因此可以在其他区域配置辅助数据库副本。 在数据中心发生服务中断或无法连接到主数据库时，可以使用辅助数据库进行查询和故障转移。 有关详细信息，请参阅[故障转移组和活动异地复制](/azure/sql-database/sql-database-geo-replication-overview)（SQL 数据库）和[如何使用 Azure Cosmos DB 全局分发数据](/azure/cosmos-db/distribute-data-globally)。

**使用乐观并发和最终一致性**。 通过锁定（悲观并发）阻止访问资源的事务可能会导致性能不佳，并大幅降低可用性。 这些问题在分布式系统中可能会变得特别严重。 在许多情况下，谨慎的设计和方法（例如分区）可以将发生更新冲突的可能性降到最低。 复制数据或者从独立更新的存储中读取数据时，数据只会保持最终一致性。 但其优点通常超越了使用事务来确保即时一致性所导致的可用性影响。

**使用定期备份和时间点还原**。 定期自动备份未保留在其他位置的数据，并确认可以在发生故障时可靠还原数据和应用程序本身。 确保备份符合恢复点目标 (RPO)。 数据复制不是备份功能，因为人为错误或恶意操作可能会损坏所有副本中的数据。 备份过程必须是安全的，这样才能保护传输中和存储中的数据。 数据库或部分数据存储通常可以使用事务日志恢复到以前的某个时间点。 有关详细信息，请参阅[发生数据损坏或意外删除后进行恢复](../resiliency/recovery-data-corruption.md)

## <a name="errors-and-failures"></a>错误和故障

**配置请求超时。** 服务和资源可能会变为不可用，导致请求失败。 请确保应用的超时适合每个服务或资源，以及访问服务或资源的客户端。 在某些情况下，可能需要根据客户端正在执行的上下文和其他操作，对特定的客户端实例允许较长的超时。 太短的超时可能对产生较长延迟的服务和资源造成过多的重试操作。 如果大量的请求正在排队等待服务或资源做出响应，则很长的超时可能会导致阻塞。

**重试暂时性故障导致的失败操作。** 设计重试策略，以便在所有服务和资源原本不支持自动连接重试的情况下访问这些服务和资源。 使用适当的策略，规定随着故障次数的增加，每两次重试的间隔延迟时间也会增加，以避免资源过载，并允许资源正常恢复和处理排队的请求。 以很短的延迟连续重试可能会使问题恶化。 有关详细信息，请参阅[特定服务的重试指南](../best-practices/retry-service-specific.md)。

**实施断路以避免出现连锁故障。** 在某些情况下，暂时性故障或其他故障（严重性范围从部分连接断开到服务完全故障）花费比预期更长的时间才能恢复正常。 如果服务非常繁忙，系统中某个部件的故障可能会导致连锁故障，并导致许多操作在占用重要系统资源（例如内存、线程和数据库连接）时遭到阻止。 应用程序不应连续重试不太可能成功的操作，而应快速接受操作失败的事实，并适当地处理这种失败。 可以使用断路器模式在定义的时间段内拒绝对特定操作的请求。 有关详细信息，请参阅[断路器模式](../patterns/circuit-breaker.md)。

**组建或故障回复到多个组件。** 将应用程序设计为尽可能使用多个实例且不影响操作和现有连接。 使用多个实例并分散它们之间的请求，检测并避免向故障的实例发送请求，以便最大化可用性。

**故障回复到不同的服务或工作流。** 例如，如果写入 SQL 数据库失败，请暂时将数据存储在 Blob 存储或 Redis 缓存中。 提供某种途径方便在服务可用时将数据重新写入 SQL 数据库。 在某些情况下，失败的操作可能有替代操作允许应用程序继续工作，即使组件或服务发生故障。 如果可能，请检测故障并将请求重定向到其他可提供适当替代功能的服务，或者在主服务脱机时，备份或减少可保持核心操作的功能实例。

## <a name="monitoring-and-disaster-recovery"></a>监视和灾难恢复

**针对可能的故障和故障事件提供丰富的检测**，以将情况汇报给操作人员。 针对可能但尚未发生的故障提供足够的数据，以便操作人员确定其原因，缓解局面，并确保系统保持可用。 针对已发生的故障，应用程序应该将适当的错误消息返回给用户，但仍然尝试继续运行，尽管功能降低。 在各种情况下，监视系统应该捕获完整的详细信息，以便操作人员实施快速恢复，并根据需要让设计人员和开发人员修改系统，以防止再次发生此情况。

**通过实施检查功能来监视系统运行状况。** 应用程序的运行状况和性能可能在不同时间出现不明显的降级，直到发生故障为止。 实施探测或定期从应用程序外部执行检查功能。 这些检查与度量整个应用程序、应用程序的单个部件、应用程序使用的单个服务和单个组件的响应时间一样简单。 检查功能可以一些进程来确保生成有效的结果、度量延迟、检查可用性，并从系统中提取信息。

**定期测试所有故障转移和故障回复系统。** 对系统和操作的更改可能会影响故障转移和故障回复功能，但是在主系统发生故障或过载之前可能无法检测到这种影响。 先测试系统，以防在运行时弥补实时问题。

**测试监视系统。** 自动化故障转移和故障回复系统，以及使用仪表板手动进行系统运行状况和性能可视化，都依赖于监视和检测功能的正常运行。 如果这些元素发生故障、遗漏重要信息或报告错误的数据，操作人员可能不知道系统不正常或即将发生故障。

**跟踪长时间运行的工作流的进度并在故障时重试。** 长时间运行的工作流通常由多个步骤组成。 确保每个步骤都是独立且可以重试的，以最大程度地减少整个工作流需要回滚，或需要执行多个补偿事务的可能性。 通过实施[计划程序代理监督程序模式](../patterns/scheduler-agent-supervisor.md)等模式，来监视和管理长时间运行的工作流的进度。

**规划灾难恢复。** 创建一个可接受的且经过完全测试的计划，从可能影响系统可用性的任何故障类型中恢复。 为任意任务关键型应用程序选择多站点灾难恢复体系结构。 标识包括自动化和测试在内的灾难恢复计划的特定所有者。 确保此计划有案可稽并且尽可能自动化该过程。 为所有引用和事务数据制定备份策略，并定期测试这些备份的恢复效果。 培训操作人员执行该计划，并进行常规灾难模拟以验证和改进计划。

<!-- links -->
[availability-sets]:/azure/virtual-machines/virtual-machines-windows-manage-availability/
